name: Deploy Application

on:
  push:
    branches:
      - main  # Ou a branch de onde deseja fazer o deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Fazer checkout do c처digo
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. Configurar a chave SSH para acesso ao servidor
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh  # Cria o diret처rio .ssh se n찾o existir
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 145.223.27.56 >> ~/.ssh/known_hosts

      # 3. Deploy da API para o diret처rio de `api.cooperativasolarman.com.br`
      - name: Deploy API
        run: |
          rsync -avz --exclude '.git' ./api/ solar@145.223.27.56:/htdocs/api.cooperativasolarman.com.br/public
          ssh solar@145.223.27.56 << 'EOF'
            cd /htdocs/api.cooperativasolarman.com.br/public
            npm install
            pm2 restart api
          EOF